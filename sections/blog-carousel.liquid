{% liquid
  assign blog = section.settings.blog
  assign articles_limit = section.settings.post_limit
%}

<div class="section section--page-width blog-carousel color-{{ section.settings.color_scheme }}" data-blog-carousel>
  <div class="blog-carousel__header">
    {% if section.settings.heading != blank %}
      <h2 class="blog-carousel__heading">{{ section.settings.heading }}</h2>
    {% endif %}
    <div class="blog-carousel__controls">
      <button type="button" class="blog-carousel__arrow blog-carousel__arrow--prev" data-prev aria-label="Ver artículos anteriores">
        <span aria-hidden="true">&#8592;</span>
      </button>
      <button type="button" class="blog-carousel__arrow blog-carousel__arrow--next" data-next aria-label="Ver artículos siguientes">
        <span aria-hidden="true">&#8594;</span>
      </button>
    </div>
  </div>

  <div class="blog-carousel__viewport" data-viewport>
    <ul class="blog-carousel__track" data-track>
      {% if blog and blog.articles_count > 0 %}
        {% for article in blog.articles limit: articles_limit %}
          <li class="blog-carousel__item">
            <article class="blog-card">
              <a href="{{ article.url }}" class="blog-card__media" aria-label="{{ article.title }}">
                {% if article.image %}
                  {{
                    article.image
                    | image_url: width: 900
                    | image_tag:
                      class: 'blog-card__image',
                      widths: '400, 600, 800',
                      sizes: '(min-width: 990px) 28vw, 100vw',
                      loading: 'lazy'
                  }}
                {% else %}
                  <div class="blog-card__image blog-card__image--placeholder"></div>
                {% endif %}
              </a>
              <div class="blog-card__content">
                <h3 class="blog-card__title">
                  <a href="{{ article.url }}">{{ article.title }}</a>
                </h3>
                {% if article.excerpt != blank %}
                  <p class="blog-card__excerpt">{{ article.excerpt | strip_html | truncatewords: 14 }}</p>
                {% else %}
                  <p class="blog-card__excerpt">{{ article.blog.title }}</p>
                {% endif %}
              </div>
            </article>
          </li>
        {% endfor %}
      {% else %}
        {% for i in (1..articles_limit) %}
          <li class="blog-carousel__item">
            <article class="blog-card">
              <div class="blog-card__media">
                {{ 'image' | placeholder_svg_tag: 'placeholder' }}
              </div>
              <div class="blog-card__content">
                <h3 class="blog-card__title"><a href="#">Entrada destacada</a></h3>
                <p class="blog-card__excerpt">Comparte historias, recetas y tips de Aurora Café.</p>
              </div>
            </article>
          </li>
        {% endfor %}
      {% endif %}
    </ul>
  </div>
</div>

{% stylesheet %}
  .blog-carousel {
    padding-block: clamp(3rem, 6vw, 4.5rem);
  }

  .blog-carousel__header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    gap: clamp(1rem, 3vw, 2rem);
    margin-bottom: clamp(2rem, 4vw, 3rem);
  }

  .blog-carousel__heading {
    margin: 0;
    font-family: var(--font-heading--family);
    font-weight: 700;
    font-size: clamp(2rem, 4vw, 2.25rem);
    color: rgb(var(--color-foreground-heading-rgb));
  }

  .blog-carousel__controls {
    display: inline-flex;
    gap: 0.75rem;
  }

  .blog-carousel__arrow {
    width: 44px;
    height: 44px;
    border-radius: 50%;
    border: 1px solid transparent;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    background-color: #795838;
    color: #ffffff;
    transition: transform 0.2s ease, background-color 0.2s ease, border-color 0.2s ease, color 0.2s ease;
    cursor: pointer;
  }

  .blog-carousel__arrow.is-disabled {
    background: transparent;
    border-color: rgba(121, 88, 56, 0.35);
    color: rgba(121, 88, 56, 0.5);
    cursor: default;
    transform: none;
  }

  .blog-carousel__arrow:not(.is-disabled):hover,
  .blog-carousel__arrow:not(.is-disabled):focus-visible {
    transform: translateY(-2px);
  }

  .blog-carousel__viewport {
    overflow: hidden;
    margin-inline: -1rem;
    padding-inline: 1rem;
  }

  .blog-carousel__track {
    display: grid;
    grid-auto-flow: column;
    grid-auto-columns: minmax(220px, 1fr);
    gap: clamp(1.5rem, 3vw, 2.5rem);
    overflow-x: auto;
    scroll-snap-type: x mandatory;
    scrollbar-width: none;
    padding-bottom: 1rem;
  }

  .blog-carousel__track::-webkit-scrollbar {
    display: none;
  }

  .blog-carousel__item {
    scroll-snap-align: center;
  }

  .blog-card {
    display: grid;
    gap: 1rem;
  }

  .blog-card__media {
    display: block;
    border-radius: 8px;
    overflow: hidden;
    height: 247px;
  }

  .blog-card__image {
    width: 100%;
    height: 100%;
    object-fit: cover;
    display: block;
  }

  .blog-card__image--placeholder {
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, rgba(0, 0, 0, 0.08), rgba(0, 0, 0, 0.02));
  }

  .blog-card__title {
    margin: 0;
    font-family: var(--font-heading--family);
    font-weight: 700;
    font-size: 1.05rem;
  }

  .blog-card__title a {
    text-decoration: none;
    color: rgb(var(--color-foreground-heading-rgb));
  }

  .blog-card__title a:hover,
  .blog-card__title a:focus-visible {
    text-decoration: underline;
  }

  .blog-card__excerpt {
    margin: 0;
    font-family: var(--font-body--family);
    font-weight: 400;
    font-size: 0.95rem;
    line-height: 1.5;
    color: rgba(0, 0, 0, 0.7);
  }

  @media (max-width: 749px) {
    .blog-carousel__header {
      flex-direction: column;
      align-items: stretch;
    }

    .blog-carousel__controls {
      align-self: flex-end;
    }

    .blog-carousel__track {
      grid-auto-columns: minmax(220px, 1fr);
    }
  }
{% endstylesheet %}

<script>
  (function() {
    const initBlogCarousel = (root) => {
      if (!root) return;
      const track = root.querySelector('[data-track]');
      const prevBtn = root.querySelector('[data-prev]');
      const nextBtn = root.querySelector('[data-next]');
      if (!track || !prevBtn || !nextBtn) return;

      const updateControls = () => {
        const scrollLeft = track.scrollLeft;
        const maxScroll = track.scrollWidth - track.clientWidth - 1;
        if (scrollLeft <= 1) {
          prevBtn.classList.add('is-disabled');
        } else {
          prevBtn.classList.remove('is-disabled');
        }
        if (scrollLeft >= maxScroll) {
          nextBtn.classList.add('is-disabled');
        } else {
          nextBtn.classList.remove('is-disabled');
        }
      };

      const scrollByAmount = () => {
        const item = track.querySelector('.blog-carousel__item');
        const itemWidth = item ? item.getBoundingClientRect().width : track.clientWidth;
        const style = getComputedStyle(track);
        const gap = parseFloat(style.columnGap || style.gap || 24);
        return itemWidth + gap;
      };

      prevBtn.addEventListener('click', () => {
        if (prevBtn.classList.contains('is-disabled')) return;
        track.scrollBy({ left: -scrollByAmount(), behavior: 'smooth' });
      });

      nextBtn.addEventListener('click', () => {
        if (nextBtn.classList.contains('is-disabled')) return;
        track.scrollBy({ left: scrollByAmount(), behavior: 'smooth' });
      });

      let rafId;
      const onScroll = () => {
        if (rafId) cancelAnimationFrame(rafId);
        rafId = requestAnimationFrame(updateControls);
      };

      track.addEventListener('scroll', onScroll, { passive: true });
      window.addEventListener('resize', updateControls);
      updateControls();
    };

    document.addEventListener('DOMContentLoaded', () => {
      document.querySelectorAll('[data-blog-carousel]').forEach(initBlogCarousel);
    });

    document.addEventListener('shopify:section:load', (event) => {
      const section = event.target.querySelector('[data-blog-carousel]');
      if (section) initBlogCarousel(section);
    });
  })();
</script>

{% schema %}
{
  "name": "Blog carousel",
  "settings": [
    {
      "type": "text",
      "id": "heading",
      "label": "Heading",
      "default": "Artículos del blog"
    },
    {
      "type": "blog",
      "id": "blog",
      "label": "Blog"
    },
    {
      "type": "range",
      "id": "post_limit",
      "label": "Cantidad de artículos",
      "min": 1,
      "max": 12,
      "step": 1,
      "default": 6
    }
  ],
  "presets": [
    {
      "name": "Blog carousel"
    }
  ]
}
{% endschema %}